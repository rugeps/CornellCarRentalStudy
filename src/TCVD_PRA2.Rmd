---
title: 'M2.951 - Tipologia i cicle de vida de les dades'
subtitle: 'Pràctica 2 - Neteja i anàlisi de les dades'
author: 'Autor: Roger Perís Serrano i Albert Cámara Viñals'
date: '`r format(Sys.Date(), "Desembre, %Y")`'
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 3
    includes:
      in_header: header.html
  word_document: default
  pdf_document:
    latex_engine: xelatex
    highlight: zenburn
    toc: yes
bibliography: bibliography_tcvd_pra_2.bib    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Detalls de l'activitat

## Presentació

En aquesta pràctica s’elabora un cas pràctic orientat a aprendre a identificar les dades rellevants per un projecte analític i usar les eines d’integració, neteja, validació i anàlisi de les mateixes. Per fer aquesta pràctica haureu de treballar en grups de 2 persones. Haureu de lliurar un sol fitxer amb l’enllaç Github (https://github.com) on es trobin les solucions incloent els noms dels components de l’equip. Podeu utilitzar la Wiki de Github per descriure el vostre equip i els diferents arxius que corresponen a la vostra entrega. Cada membre de l’equip haurà de contribuir amb el seu usuari Github. Malgrat que no es tracta del mateix enunciat, els següents exemples d’edicions anteriors us poden servir com a guia:

* Exemple: https://github.com/Bengis/nba-gap-cleaning
* Exemple complex (fitxer adjunt).

## Competències

En aquesta pràctica es desenvolupen les següents competències del Màster de Data Science:

* Capacitat d'analitzar un problema en el nivell d'abstracció adequat a cada situació i aplicar les habilitats i coneixements adquirits per abordar-lo i resoldre'l.
* Capacitat per aplicar les tècniques específiques de tractament de dades (integració, transformació, neteja i validació) per al seu posterior anàlisi.

## Objectius

Els objectius concrets d’aquesta pràctica són:

* Aprendre a aplicar els coneixements adquirits i la seva capacitat de resolució de problemes en entorns nous o poc coneguts dintre de contextos més amplis o multidisciplinaris.
* Saber identificar les dades rellevants i els tractaments necessaris (integració, neteja i validació) per dur a terme un projecte analític.
* Aprendre a analitzar les dades adequadament per abordar la informació continguda en les dades.
* Identificar la millor representació dels resultats per tal d’aportar conclusions sobre el problema plantejat en el procés analític.
* Actuar amb els principis ètics i legals relacionats amb la manipulació de dades en funció de l'àmbit d'aplicació.
* Desenvolupar les habilitats d'aprenentatge que els permetin continuar estudiant d'una manera que haurà de ser en gran manera autodirigida o autònoma.
* Desenvolupar la capacitat de cerca, gestió i ús d'informació i recursos en l'àmbit de la ciència de dades.


## Descripció de la Pràctica a realitzar

L’objectiu d’aquesta activitat serà el tractament d’un dataset, que pot ser el creat a la pràctica 1 o bé qualsevol dataset lliure disponible a Kaggle (https://www.kaggle.com). Alguns exemples de dataset amb els que podeu treballar són:

* Red Wine Quality (https://www.kaggle.com/uciml/red-wine-quality-cortez-et-al-2009 ).
* Titanic: Machine Learning from Disaster (https://www.kaggle.com/c/titanic ).

L’últim exemple correspon a una competició activa a Kaggle de manera que, opcionalment, podeu aprofitar el treball realitzat durant la pràctica per entrar en aquesta competició.

Seguint les principals etapes d’un projecte analític, les diferents tasques a realitzar (i justificar) són les següents:

1. Descripció del dataset. Perquè és important i quina pregunta/problema pretén respondre?
2. Integració i selecció de les dades d’interès a analitzar.
3. Neteja de les dades.
  + Les dades contenen zeros o elements buits? Com gestionaries aquests casos?
  + Identificació i tractament de valors extrems.
4. Anàlisi de les dades.
  + Selecció dels grups de dades que es volen analitzar/comparar (planificació delsanàlisis a aplicar).
  + Comprovació de la normalitat i homogeneïtat de la variància.
  + Aplicació de proves estadístiques per comparar els grups de dades. En funció de les dades i de l’objectiu de l’estudi,     aplicar proves de contrast d’hipòtesis, correlacions, regressions, etc. Aplicar almenys tres mètodes d’anàlisi             diferents.
5. Representació dels resultats a partir de taules i gràfiques.
6. Resolució del problema. A partir dels resultats obtinguts, quines són les conclusions? Els resultats permeten respondre al problema?
7. Codi: Cal adjuntar el codi, preferiblement en R, amb el que s’ha realitzat la neteja, anàlisi i representació de les dades. Si ho preferiu, també podeu treballar en Python.

## Recursos

Els següents recursos són d’utilitat per la realització de la pràctica:

* Calvo M., Subirats L., Pérez D. (2019). Introducción a la limpieza y análisis de los datos. Editorial UOC.
* Megan Squire (2015). Clean Data. Packt Publishing Ltd.
* Jiawei Han, Micheine Kamber, Jian Pei (2012). Data mining: concepts and techniques. Morgan Kaufmann.
* Jason W. Osborne (2010). Data Cleaning Basics: Best Practices in Dealing with Extreme Scores. Newborn and Infant Nursing Reviews; 10 (1): pp. 1527-3369.
* Peter Dalgaard (2008). Introductory statistics with R. Springer Science & Business Media.
* Wes McKinney (2012). Python for Data Analysis. O’Reilley Media, Inc.
* Tutorial de Github https://guides.github.com/activities/hello-world.

## Criteris de valoració

Tots els apartat són obligatoris. La ponderació dels exercicis és la següent:

* Els apartats 1, 2 i 6 valen 0,5 punts.
* Els apartats 3, 5 i 7 valen 2 punts.
* L’apartat 4 val 2,5 punts.

Es valorarà la idoneïtat de les respostes, que han de ser clares i completes. Les diferents etapes han d’estar ben justificades i acompanyades del codi corresponent. També es valorarà la síntesi i claredat, a través de l’ús de comentaris, del codi resultant, així com la qualitat de les dades finals analitzades.

## Format i data de lliurament

Durant la setmana del 21 al 25 de desembre el grup podrà lliurar al professor una entrega parcial opcional. Aquesta entrega parcial és molt recomanable per tal de rebre assessorament sobre la pràctica i verificar que la direcció presa és la correcta. Es lliuraran comentaris als estudiants que hagin efectuat l’entrega parcial però no comptarà per la nota de la pràctica. En l’entrega parcial els estudiants hauran de lliurar per correu electrònic, al profesor encarregat de l’aula, l’enllaç al repositori Github amb el que hagin avançat.

Pel que fa a l’entrega final, cal lliurar un únic fitxer que contingui l’enllaç a Github, el qual no es podrà modificar posteriorment a la data d’entrega, on hi hagi:

1. Una Wiki on hi hagi els noms dels components del grup i una descripció dels fitxers.
2. Un document Word, Open Office o PDF amb les respostes a les preguntes i els noms
dels components del grup. A més, al final de document, haurà d’aparèixer la següent taula
de contribucions al treball, la qual ha de signar cada integrant del grup amb les seves
inicials. Les inicials representen la confirmació de que l’integrant ha participat en aquell apartat. Tots els integrants han de participar en cadascun dels apartats, de manera que,
idealment, els apartats hauran d’estar signats per tots els integrants.
3. Una carpeta amb el codi generat per analitzar les dades.
4. El fitxer CSV amb les dades originals.
5. El fitxer CSV amb les dades finals analitzades.

Aquest document de l’entrega final de la Pràctica 2 s’ha de lliurar a l’espai de Lliurament i Registre d’AC de l’aula abans de les 23:59 del dia 5 de gener. No s’acceptaran lliuraments fora de termini.

# Resolució

Contribucions               | Firma
-------------               | -------------
Investigació prèvia         | RPS, ACV
Redacció de les respostes   | RPS, ACV
Desenvolupament codi        | RPS, ACV

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carreguem les llibreries que farem servir
library(tidyverse)
library(ggplot2)
library(dplyr)
library(GGally)
library(arules)
library(reshape2)
library(regclass)
library(car)
library(nortest)
library(gridExtra)
library(ResourceSelection)

old <- theme_set(theme_minimal())
```





## Descripció del dataset

El conjunt de dades que analitzarem serà: Cornell Car Rental Dataset, s'ha obtingut del repositori de dades Kaggle (https://www.kaggle.com/kushleshkumar/cornell-car-rental-dataset?select=CarRentalData.csv). Aquest joc de dades és un recull de registres de diferents portals de lloguer de vehicles a les principals ciutats d'Estats Units, i s'ha generat mitjançant *webscraping*, amb una extracció relitzada al Julol del 2020. Està format per 16 característiques (columnes o atributs) que presentan 5851 registres (files o observacions). Cada una de les obseravacions es correspon a les característiques d'un vehicle de lloguer.

Les característiques, atributs o variables per cada observació (es manté el nom original en anglès) són:

* *fuelType:* Tipus de combustible utilitzat pel vehicle. 
* *rating:* Qualificació acumulativa del cotxe per part dels clients
* *renterTripsTaken:* Nombre de viatges realitzats per aquest vehicle (durada desconeguda)
* *reviewCount:* Nombre de valoracions
* *location.city:* Ciutat en què es troba el vehicle
* *location.country:* País en què es troba el vehicle
* *location.latitude:* Coordenada geogràfica (latitud) en què es troba el vehicle
* *location.longitude:* Coordenada geogràfica (longitud) en què es troba el vehicle
* *location.state:* Estat en què es troba el vehicle
* *owner.id:* Identificador (ID) del propietàri del vehicle
* *rate.daily:* Tarifa diària en dòlars
* *vehicle.make:* Marca del vehicle 
* *vehicle.model:* Model del vehicle
* *vehicle.type:* Tipus de vehicle
* *vehicle.year:* Any del vehicle (matriculació)
* *airportcity:* Ciutat de l'aeroport més proper a la localització en què es troba el vehicle (normalment es des d'on es realitza el lloguer del vehicle).



## Importància i objectius de l'anàlisi

Amb l'entrada en vigor de les zones de zero emissions a les grans ciutats, la classificació de vehicles segons el seu gran de contaminació i de l'objectiu de zero emissions al 2050, promogut per la Comisió Euopea han generat un gran debat envers la compra o lloguer de vehicles. De fet hi ha diversos estudis que mostren que en els últims anys hi ha hagut un increment en el mercat de lloguer de vehicles o *renting*. A partir del joc de dades escollit "Cornell Car Rental Dataset" ens proposem determinar quines variables influeixen més sobre el preu d’un automòbil de lloguer, en el nombre de vegades que es lloga i la seva valoració. A més, es generarà un model de regressió lineal múltple que permeti predir el preu d’un vehicle de lloguer en funció de les seves característiques. A més es duran a terme diferents constrastos d'hipótesis que permetin identificar propietats interessants subyacents en les mostres que puguin ser inferidas respecte a la población.

Aquests anàlisis són de gran rellevància en gairebé qualsevol sector relacionat amb el lloguer de vehicles. Per una banda pot resultar interessant per les agències de lloguer, ja que aquestes podran conèixer amb més detall els seus clients, i per tant generar ofertes personalitzades o decidir quin és el preu més adient o quin model de vehicle és més adequat per renovar la flota. D'altre banda també pot resultar interessant per a l'usuari final, ja que a partir de les seves necesitats podrà determinar si li convé llogar un vehicle o no o si el seu preu és correspont amb el del mercat actual.


## Neteja de dades

### Lectura de dades

En primer lloc, obrim el fitxer de dades i examinem el tipus de dades amb els que R ha interpretat cada variable. A més examinem també els valors resum de cada tipus de variable.

Comencem carregant el joc de dades en un dataframe d'*R*.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carreguem el joc de dades
ds <- read.csv('../data/CarRentalDataV1.csv', stringsAsFactors = FALSE, header = TRUE, sep=',', strip.white = TRUE)
```

Tot seguit examinem l'estructura del joc de dades, per validar que s'han interpetat correctament.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Verifiquem les dimensions del joc de dades
dim(ds)

# Verifiquem l'estructura del joc de dades
str(ds)
```

A partir dels detalls anteriors podem veure que disposem d'un joc de dades amb 5851 observacions, amb 16 atributs o variables per observació i que el tipus de dades s'ha interpretat correctament.

### Previsualització de les dades d'interès

A continuació realitzem una previsualització, anàlisi visual de les dades, per intentar identificar les possibles anomalies, distribucions i característiques de les diferents variables.

Per això el primer que farem serà distingir les variables categòriques de les variables numèriques. la qual cosa ens facilitarà el tractament futur. 

```{r echo=TRUE, message=FALSE, warning=FALSE}
categorical_features_names = c('fuelType', 'location.city', 'location.country', 'location.state', 'owner.id', 'vehicle.make', 'vehicle.model', 'vehicle.type', 'airportcity') 

numeric_features_names = c('rating', 'renterTripsTaken', 'reviewCount', 'location.latitude', 'location.longitude', 'rate.daily', 'vehicle.year')
```

**Anàlisi univariant** 

Comencem visualitzant els principals descriptors estadístics de cadascuna de les variables numèriques.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Mostrem un resum dels principals estadístics de cada variable
summary(ds[, numeric_features_names])
```

**Visualització gràfica de les dades**

Tot seguit visualitzem les distribucions dels valors de les variables numèriques.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculem histogrames de les variables numèriques
hist01 <- ggplot(data=ds, aes(x=rating)) + geom_histogram(bins = 20) + xlab('Rating') + ylab('Freqüència')
hist02 <- ggplot(data=ds, aes(x=renterTripsTaken)) + geom_histogram(bins=30) + xlab('Renter Trips Taken') + ylab('Freqüència')
hist03 <- ggplot(data=ds, aes(x=reviewCount)) + geom_histogram(bins=30) + xlab('Review Count') + ylab('Freqüència')
hist04 <- ggplot(data=ds, aes(x=location.latitude)) + geom_histogram(bins=10) + xlab('Latitut') + ylab('Freqüència')
hist05 <- ggplot(data=ds, aes(x=location.longitude)) + geom_histogram(bins=10) + xlab('Longitut') + ylab('Freqüència')
hist06 <- ggplot(data=ds, aes(x=rate.daily)) + geom_histogram(bins=30) + xlab('Daily rate') + ylab('Freqüència')
hist07 <- ggplot(data=ds, aes(x=vehicle.year)) + geom_histogram(bins=13) + xlab('Vehicle Year') + ylab('Freqüència')

grid.arrange(hist01, hist02, hist03, hist04, nrow = 2, ncol = 2)
grid.arrange(hist05, hist06, hist07, nrow = 2, ncol = 2)
```

Un altre de les visualitzacions que sol ser de força utilitat per analitzar els jocs de dades són els diagrames de caixes, amb aquests podem observar la dispersió de les dades. A continuació visualitzarem els diagrames de caixes dels atributs numèrics.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculem diagrames de caixa de les variables numèriques
box01 <-ggplot(ds, aes(y=rating)) + geom_boxplot()
box02 <-ggplot(ds, aes(y=renterTripsTaken)) + geom_boxplot()
box03 <-ggplot(ds, aes(y=reviewCount)) + geom_boxplot()
box04 <-ggplot(ds, aes(y=location.latitude)) + geom_boxplot()
box05 <-ggplot(ds, aes(y=location.longitude)) + geom_boxplot()
box06 <-ggplot(ds, aes(y=rate.daily)) + geom_boxplot()
box07 <-ggplot(ds, aes(y=vehicle.year)) + geom_boxplot()

grid.arrange(box01, box02, box03, box04,  nrow = 2, ncol = 2)

grid.arrange(box05, box06, box07, nrow = 2, ncol = 2)
```

A continuació podem veure un detall d'aquests possibles valors extrems.

```{r echo=TRUE, message=FALSE, warning=FALSE}
n <- length(ds$rating)

n - boxplot.stats(ds$rating)$n

n - boxplot.stats(ds$renterTripsTaken)$n

n - boxplot.stats(ds$reviewCount)$n

n - boxplot.stats(ds$location.latitude)$n

n - boxplot.stats(ds$location.longitude)$n

n - boxplot.stats(ds$rate.daily)$n

n- boxplot.stats(ds$vehicle.year)$n
```

Continuem visualitzant les distribucions dels valors de les variables categòriques

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculem gràfics de barres de les variables categòriques

```

### Zeros i atributs buits

Ara farem el tractament dels valors buits i convertirem les variables discretes a factors.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Estadístiques de valors buits, validem si hi ha valors buits
colSums(is.na(ds))
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Estadístiques de valors buits, validem si hi ha valors buits
colSums(ds=="")
```

Es pot veure que per 2 variables tenim valors buits (fuelType i rating). Anem a calcular doncs per cada una d’aquestes 2 variables quin és el seu valor més freqüent 

```{r echo=TRUE, message=FALSE, warning=FALSE}
most_freq_fuelType <- names(which.max(table(ds$fuelType)))
most_freq_rating <- names(which.max(table(ds$rating)))

most_freq_fuelType
most_freq_rating
```

Assignem el valor més freqüent als valors buits i comprovem que després del tractament no hi hagi valors buits

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Prenem el valor més freqüent per als valors buits
ds$fuelType[ds$fuelType == ""] = most_freq_fuelType
ds$rating[is.na(ds$rating)] = as.numeric(most_freq_rating)

# Visualitzem de nou si hi ha valors buits
colSums(is.na(ds))
colSums(ds=="")
```


### Valors extrems (Outliers)

Després del tractament dels valors buits examinem de nou els possibles valors extrems.

```{r echo=TRUE, message=FALSE, warning=FALSE}
n <- length(ds$rating)

n - boxplot.stats(ds$rating)$n
```

 veure com el joc de dades ja no presenta valors extrems. I que els valors extrems es corresponien amb dades buides.

### Discretització de variables

Ara examinarem per quines variables tindria sentit realitzar una discretització.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Per a quines variables tindria sentit un procés de discretizació?
apply(ds, 2, function(x) length(unique(x)))
```

Per aquelles variables amb pocs valors possibles podem realitzar una discretització. Per això convertim les variables discretes a factors d'*R*.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Convertim les variables discretes a factors
ds[,categorical_features_names] <- lapply(ds[,categorical_features_names] , factor)

# Mostrem el resultat
str(ds)
```

### Transformació d'atributs

A continuació realitzarem algunes transformacions sobre alguns atributs, amb la finalitat de generar diferents punts de vista de les dades.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Discretització amb intevals prefixats, de les valoracions
table(discretize(ds$rating, method = "fixed", c(0, 4.5, Inf), labels = c('Bad', 'Good')))

hist(ds$rating, breaks = 20, main = "Discretització amb intervals prefixats", xlab = "Valoració")
cuts_rating <- discretize(ds$rating, method = "fixed",c(0, 4.5, Inf), onlycuts = TRUE)
abline(v = cuts_rating, col = "red")
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Discretització amb intevals prefixats, de les valoracions
ds['rating.discret'] <- discretize(ds$rating, method = "fixed", breaks = c(0, 4.5, Inf), labels = c('Bad', 'Good'))

ds$rating.discret = as.factor(ds$rating.discret)

# Calculem gràfic de barres
ggplot(data=ds, aes(x = rating.discret)) + geom_bar(aes(y = (..count..)/sum(..count..))) + geom_text(aes(y = ((..count..)/sum(..count..)), label = scales::percent((..count..)/sum(..count..))), stat = "count", vjust = -0.5) + scale_y_continuous(labels = scales::percent, limits = c(0,1)) + xlab('Rent') + ylab("Percentatge")
```

### Creació de nous indicadors

Un altre dels passos interessant en l'anàlisi d'un joc de dades és la generació de nous atributs a partir dels existents. 

Creem un nou indicador o atribut on emmagatzemem l'antiguitat del vehicle.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Antiguitat del vehicle
ds['age'] <- as.integer(format(Sys.Date(), "%Y")) - ds$vehicle.year

# Calculem gràfic de barres de la nova variable
ggplot(data=ds, aes(x = age)) + geom_bar(aes(y = (..count..)/sum(..count..))) + scale_x_continuous(breaks = round(seq(min(ds$age), max(ds$age), by = 5), 1)) + xlab('Age') + ylab("Percentatge")
```

Creem un altre indicador o atribut nou on emmagatzemem si el vehicle va ser llogat o no.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Vehicle llogat/no llogat
ds['rent'] <- ifelse(ds['renterTripsTaken'] > 0, 1, 0)
ds$rent <- as.factor(ds$rent)
levels(ds$rent) <- c("Not","Yes")

# Calculem gràfic de barres de la variable objectiu
ggplot(data=ds, aes(x = rent)) + geom_bar(aes(y = (..count..)/sum(..count..))) + geom_text(aes(y = ((..count..)/sum(..count..)), label = scales::percent((..count..)/sum(..count..))), stat = "count", vjust = -0.5) + scale_y_continuous(labels = scales::percent, limits = c(0,1)) + xlab('Rent') + ylab("Percentatge")
```

### Exportació de les dades preprocesades

Una vegada que hem realitzat sobre el conjunt de dades inicial els procediments de preprocessament integració, validació i neteja, procedim a guardar aquest nou joc de dades en un fitxer anomenat CarRentalDataV1_Clean.csv.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Exportació de les dades preprocessades a un fitxer .CSV
write.csv(ds, '../data/CarRentalDataV1_Clean.csv')
```




## Anàlisi de les dades

La gran majoria dels atributs presents en el conjunt de dades es corresponen amb característiques dels diversos vehicles de lloguer o de la seva ubicació, per tant serà convenient tenir-los en consideració durant la realització de les anàlisis. No obstant això, podem prescindir de dos atributs, les coordenades geogràfiques (location.latitude i location.longitude) ja que la informació que ens aporten aquestes variables ja es troba implicita en la resta d'atributs de localització  i, per tant, són menys rellevants a l' hora de resoldre el nostre problema.


### Selecció dels grups de dades a analitzar

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Eliminem les coordenades geogràfiques
ds <- ds[, -(7:8)]

categorical_features_names = c('fuelType', 'location.city', 'location.country', 'location.state', 'owner.id', 'vehicle.make', 'vehicle.model', 'vehicle.type', 'airportcity') 

numeric_features_names = c('rating', 'renterTripsTaken', 'reviewCount', 'rate.daily', 'age')
```

### Comprobació de la normalitat i homogeneitat de la varianza

Per a la comprovació que els valors que prenen les nostres variables quantitatives provenen d'una població distribuïda normalment, utilitzarem la prova de normalitat d'Anderson-Darling. Per això, es comprova que perquè cada prova s'obté un *p-valor* superior el nivell de significació prefixat = 0. 05 (Nivell de confiança del 95%). Si això es compleix, llavors es considera que la variable en qüestió segueix una distribució normal.

**Test de normalitat**

```{r echo=TRUE, message=FALSE, warning=FALSE}
alpha = 0.05
col.names = colnames(ds)

for (i in 1:ncol(ds)) {
  if (i == 1) cat("Variables que no presenten una distribució normal:\n")
    if (is.integer(ds[,i]) | is.numeric(ds[,i])) {
      p_val = ad.test(ds[,i])$p.value
      if (p_val < alpha) {
        cat(col.names[i])
        # Format output
        if (i < ncol(ds) - 1) cat(", ")
        if (i %% 3 == 0) cat("\n")
      }
    }
}
```

A pqartir del resultat anterior podem veure com que cap dels atributs quantitaius presenta una distribució normal. Tot i així ens centrarem ara un moment el la variable depenent o variable objectiu en el nostre estudi, el preu diari del vehicle.

Si observem els valors mínim, mitjà i màxim veiem clarament que no és una variable amb distribució normal. Però en la majoria de models numèrics d'aprenentatge automàtic, necessitarem que les variables segueixin la distribució normal. Per això podem emprar visualitzacions de les dades per analitzar la normalitat. Concretament, el gràfic Q-Q, on la Q denota quantil, és un tipus de visualització que s'utilitza per a diagnosticar la desviació de les dades de la mostra en relació amb una població normal.

```{r echo=TRUE, message=FALSE, warning=FALSE}
qqnorm(ds$rate.daily, ylab="Daily Rate", xlab="Theorical Quantiles", main="Normal Q-Q Plot") 
qqline(ds$rate.daily)
```

Quan tenim una variable que no és normal, una de les transformacions clàssiques que pot funcionar és aplicar el logaritme a la variable.

```{r echo=TRUE, message=FALSE, warning=FALSE}
ds$rate.daily <- log(ds$rate.daily)

ggplot(ds, aes(x = rate.daily)) +  geom_histogram() +  ylab("Nombre d'habitatges") + xlab("Preu de venda")
```

Veiem com ara sí que té forma normal. Ho comprovem amb el Q-Q plot per confirmar-ho.

```{r echo=TRUE, message=FALSE, warning=FALSE}
qqnorm(log(ds$rate.daily), ylab="Daily Rate", xlab="Theorical Quantiles", main="Normal Q-Q Plot") 
qqline(log(ds$rate.daily))
```

**Anàlisi multivariant** 

Per analitzar un conjunt de dades necessitem tenir en compte més d'una variable alhora. L'anàlisi bivariant permet identificar les relacions entre dues variables, i fins quina manera una pot predir l'altra.

En aquest cas podem veure quina és la relació entre el preu diari del lloguer i el nombre de vegades que s'ha llogat el vehicle amb un scatter plot o diagrama de punts.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Relació entre el preu diari del lloguer i el nombre de vegades que s'ha llogat el vehicle
ggplot(ds, aes(x=renterTripsTaken, y=rate.daily)) + geom_point()
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Relació entre el preu diari del lloguer i el nombre de vegades que s'ha llogat el vehicle
ggplot(ds, aes(x=age, y=rate.daily)) + geom_point()
```

En el cas d'una variable categòrica com el tipus de combustible o la marca del vehicle, podem visualitzar la relació amb un boxplot o diagrama de caixes.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Relació entre el preu diari del lloguer i el tipus de combustible
ggplot(ds, aes(x=fuelType, y=rate.daily, fill=fuelType)) + geom_boxplot(alpha=0.1) + stat_summary(fun.y=mean)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Relació entre el preu diari del lloguer i l'estat on es localitza el vehicle
ggplot(ds, aes(x=location.state, y=rate.daily, fill=vehicle.type)) + geom_boxplot(alpha=0.1) + stat_summary(fun.y=mean)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Relació entre el preu diari del lloguer i la marca del vehicle
ggplot(ds, aes(x=vehicle.make, y=rate.daily, fill=vehicle.make)) + geom_boxplot(alpha=0.1) + stat_summary(fun.y=mean)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Relació entre el preu diari del lloguer i el tipus de vehicle
ggplot(ds, aes(x=vehicle.type, y=rate.daily, fill=vehicle.type)) + geom_boxplot(alpha=0.1) + stat_summary(fun.y=mean)
```

Si volem visualitzar alhora les relacions creuades entre diverses variables, podem fer un pairplot.

Examinem els atributs numèrics envers si el vehicle va se llogat o no.

```{r echo=TRUE, message=FALSE, warning=FALSE}
ggpairs(ds, columns=numeric_features_names, mapping=aes(color=rent))
```

Examinem els atributs numèrics envers la qualificació que va obtenir el vehicle.

```{r echo=TRUE, message=FALSE, warning=FALSE}
ggpairs(ds, columns=numeric_features_names, mapping=aes(color=rating.discret))
```

Finalment, ens interessarà veure quins conjunts de variables estan relacionats entre si. Per això, farem servir tècniques estadístiques d'anàlisi multivariant.

Una de les eines més útils és calcular la matriu de correlació entre les variables. Amb la funció qplot i la correlació de variables, calculada amb la funció cor, podem visualitzar de manera fàcil aquelles variables més correlacionades, que corresponen a una intensitat major de color.

```{r echo=TRUE, message=FALSE, warning=FALSE}
heat <- ds[,numeric_features_names]
qplot(x=Var1, y=Var2, data=melt(cor(heat, use="p")), fill=value, geom="tile") + theme(axis.text.x = element_text(angle = 90)) + coord_fixed()
```

## Test estadístics

### ¿Quines variables quantitatives influeixen més a les valoracions?

En primer lloc, procedim a realitzar una anàlisi de correlació entre les diferents variables per determinar quines d'elles exerceixen una major influència sobre el preu diari del lloguer del vehicle. Per a això, s'utilitzarà el coeficient de correlació de Spearman, ja que hem vist que
tenim dades que no segueixen una distribució normal.

```{r echo=TRUE, message=FALSE, warning=FALSE}
corr_matrix <- matrix(nc = 2, nr = 0)
colnames(corr_matrix) <- c("estimate", "p-value")

# Calcular el coeficiente de correlación para cada variable cuantitativa
# con respecto al campo "precio"
for (i in 1:(ncol(ds) - 1)) {
  if (is.integer(ds[,i]) | is.numeric(ds[,i])) {
    spearman_test = cor.test(ds[,i], ds[,'rate.daily'], method = "spearman")
    corr_coef = spearman_test$estimate
    p_val = spearman_test$p.value
    
    # Add row to matrix
    pair = matrix(ncol = 2, nrow = 1)
    pair[1][1] = corr_coef
    pair[2][1] = p_val
    corr_matrix <- rbind(corr_matrix, pair)
    rownames(corr_matrix)[nrow(corr_matrix)] <- colnames(ds)[i]
  }
}

print(corr_matrix)
```

A partjir del resultat obtingut podem identificar quines són les variables més correlacionades amb el preu diari de lloguer en funció de la seva proximitat amb els valors -1 i +1. Tenint en compte això, queda palès com la variable més rellevant en la fixació del preu és l'antigitat del vehicle (age) seguida de les valoracions.

Nota. Per a cada coeficient de correlació es mostra també el seu *p-valor* associat, ja que aquest pot donar informació sobre el pes estadístic de la correlació obtinguda.


### ¿Els cotxes elèctric tenen un preu més elevat que els cotxes de benzina?

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

### Un altre constrast

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

### Un altre constrast

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

## Model de regressió lineal múltiple


## Conclusions




# Bibliografia
